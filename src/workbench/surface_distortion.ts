// This file was auto generated by Styx.
// Do not edit this file directly.

import { Runner, Execution, Metadata, InputPathType, OutputPathType, getGlobalRunner } from 'styxdefs';

const SURFACE_DISTORTION_METADATA: Metadata = {
    id: "6b557cde1c22a8589b67dd2c10b7db6b8b4df56a.workbench",
    name: "surface-distortion",
    package: "workbench",
};


interface SurfaceDistortionSmoothParameters {
    "@type"?: "smooth";
    "sigma": number;
    "fwhm": boolean;
}
type SurfaceDistortionSmoothParametersTagged = Required<Pick<SurfaceDistortionSmoothParameters, '@type'>> & SurfaceDistortionSmoothParameters;


interface SurfaceDistortionMatchSurfaceAreaParameters {
    "@type"?: "match-surface-area";
    "roi-metric"?: InputPathType | null | undefined;
}
type SurfaceDistortionMatchSurfaceAreaParametersTagged = Required<Pick<SurfaceDistortionMatchSurfaceAreaParameters, '@type'>> & SurfaceDistortionMatchSurfaceAreaParameters;


interface SurfaceDistortionParameters {
    "@type"?: "workbench/surface-distortion";
    "metric-out": string;
    "smooth"?: SurfaceDistortionSmoothParameters | null | undefined;
    "match-surface-area"?: SurfaceDistortionMatchSurfaceAreaParameters | null | undefined;
    "caret5-method": boolean;
    "edge-method": boolean;
    "log2"?: boolean | null | undefined;
    "surface-reference": InputPathType;
    "surface-distorted": InputPathType;
}
type SurfaceDistortionParametersTagged = Required<Pick<SurfaceDistortionParameters, '@type'>> & SurfaceDistortionParameters;


/**
 * Build parameters.
 *
 * @param sigma the size of the smoothing kernel in mm, as sigma by default
 * @param fwhm kernel size is FWHM, not sigma
 *
 * @returns Parameter dictionary
 */
function surface_distortion_smooth_params(
    sigma: number,
    fwhm: boolean = false,
): SurfaceDistortionSmoothParametersTagged {
    const params = {
        "@type": "smooth" as const,
        "sigma": sigma,
        "fwhm": fwhm,
    };
    return params;
}


/**
 * Build command-line arguments from parameters.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Command-line arguments.
 */
function surface_distortion_smooth_cargs(
    params: SurfaceDistortionSmoothParameters,
    execution: Execution,
): string[] {
    const cargs: string[] = [];
    if ((params["fwhm"] ?? false)) {
        cargs.push(
            "-smooth",
            String((params["sigma"] ?? null)),
            "-fwhm"
        );
    }
    return cargs;
}


/**
 * Build parameters.
 *
 * @param roi_metric only use the surface area within a given ROI (e.g., to exclude the medial wall)

the ROI to use, as a metric file
 *
 * @returns Parameter dictionary
 */
function surface_distortion_match_surface_area_params(
    roi_metric: InputPathType | null,
): SurfaceDistortionMatchSurfaceAreaParametersTagged {
    const params = {
        "@type": "match-surface-area" as const,
    };
    if (roi_metric !== null) {
        params["roi-metric"] = roi_metric;
    }
    return params;
}


/**
 * Build command-line arguments from parameters.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Command-line arguments.
 */
function surface_distortion_match_surface_area_cargs(
    params: SurfaceDistortionMatchSurfaceAreaParameters,
    execution: Execution,
): string[] {
    const cargs: string[] = [];
    if ((params["roi-metric"] ?? null) !== null) {
        cargs.push(
            "-match-surface-area",
            "-roi",
            execution.inputFile((params["roi-metric"] ?? null))
        );
    }
    return cargs;
}


/**
 * Output object returned when calling `SurfaceDistortionParameters(...)`.
 *
 * @interface
 */
interface SurfaceDistortionOutputs {
    /**
     * Output root folder. This is the root folder for all outputs.
     */
    root: OutputPathType;
    /**
     * the output distortion metric
     */
    metric_out: OutputPathType;
}


/**
 * Build parameters.
 *
 * @param metric_out the output distortion metric
 * @param surface_reference the reference surface
 * @param surface_distorted the distorted surface
 * @param smooth smooth the area data
 * @param match_surface_area isotropically rescale the distorted surface so that it has the same surface area as the reference surface
 * @param caret5_method use the surface distortion method from caret5
 * @param edge_method calculate distortion of edge lengths rather than areas
 * @param log2 calculate distortion by the local affines between triangles

apply base-2 log transform
 *
 * @returns Parameter dictionary
 */
function surface_distortion_params(
    metric_out: string,
    surface_reference: InputPathType,
    surface_distorted: InputPathType,
    smooth: SurfaceDistortionSmoothParameters | null = null,
    match_surface_area: SurfaceDistortionMatchSurfaceAreaParameters | null = null,
    caret5_method: boolean = false,
    edge_method: boolean = false,
    log2: boolean | null = false,
): SurfaceDistortionParametersTagged {
    const params = {
        "@type": "workbench/surface-distortion" as const,
        "metric-out": metric_out,
        "caret5-method": caret5_method,
        "edge-method": edge_method,
        "surface-reference": surface_reference,
        "surface-distorted": surface_distorted,
    };
    if (smooth !== null) {
        params["smooth"] = smooth;
    }
    if (match_surface_area !== null) {
        params["match-surface-area"] = match_surface_area;
    }
    if (log2 !== null) {
        params["log2"] = log2;
    }
    return params;
}


/**
 * Build command-line arguments from parameters.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Command-line arguments.
 */
function surface_distortion_cargs(
    params: SurfaceDistortionParameters,
    execution: Execution,
): string[] {
    const cargs: string[] = [];
    if ((params["smooth"] ?? null) !== null || (params["match-surface-area"] ?? null) !== null || (params["caret5-method"] ?? false) || (params["edge-method"] ?? false) || (params["log2"] ?? false) !== null) {
        cargs.push(
            "wb_command",
            "-surface-distortion",
            (params["metric-out"] ?? null),
            ...(((params["smooth"] ?? null) !== null) ? surface_distortion_smooth_cargs((params["smooth"] ?? null), execution) : []),
            ...(((params["match-surface-area"] ?? null) !== null) ? surface_distortion_match_surface_area_cargs((params["match-surface-area"] ?? null), execution) : []),
            (((params["caret5-method"] ?? false)) ? "-caret5-method" : ""),
            (((params["edge-method"] ?? false)) ? "-edge-method" : ""),
            "-local-affine-method",
            (((params["log2"] ?? false) !== null) ? "-log2" : "")
        );
    }
    cargs.push(execution.inputFile((params["surface-reference"] ?? null)));
    cargs.push(execution.inputFile((params["surface-distorted"] ?? null)));
    return cargs;
}


/**
 * Build outputs object containing output file paths and possibly stdout/stderr.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Outputs object.
 */
function surface_distortion_outputs(
    params: SurfaceDistortionParameters,
    execution: Execution,
): SurfaceDistortionOutputs {
    const ret: SurfaceDistortionOutputs = {
        root: execution.outputFile("."),
        metric_out: execution.outputFile([(params["metric-out"] ?? null)].join('')),
    };
    return ret;
}


/**
 * MEASURE DISTORTION BETWEEN SURFACES.
 *
 * This command, when not using -caret5-method, -edge-method, or -local-affine-method, is equivalent to using -surface-vertex-areas on each surface, smoothing both output metrics with the GEO_GAUSS_EQUAL method on the surface they came from if -smooth is specified, and then using the formula 'ln(distorted/reference)/ln(2)' on the smoothed results.
 *
 * When using -caret5-method, it uses the surface distortion method from caret5, which takes the base 2 log of the ratio of tile areas, then averages those results at each vertex, and then smooths the result on the reference surface.
 *
 * When using -edge-method, the -smooth option is ignored, and the output at each vertex is the average of 'abs(ln(refEdge/distortEdge)/ln(2))' over all edges connected to the vertex.
 *
 * When using -local-affine-method, the -smooth option is ignored.  The output is two columns, the first is the area distortion ratio, and the second is anisotropic strain.  These are calculated by an affine transform between matching triangles, and then averaged across the triangles of a vertex.
 *
 * @param params The parameters.
 * @param runner Command runner
 *
 * @returns NamedTuple of outputs (described in `SurfaceDistortionOutputs`).
 */
function surface_distortion_execute(
    params: SurfaceDistortionParameters,
    runner: Runner | null = null,
): SurfaceDistortionOutputs {
    runner = runner || getGlobalRunner();
    const execution = runner.startExecution(SURFACE_DISTORTION_METADATA);
    params = execution.params(params)
    const cargs = surface_distortion_cargs(params, execution)
    const ret = surface_distortion_outputs(params, execution)
    execution.run(cargs, undefined);
    return ret;
}


/**
 * MEASURE DISTORTION BETWEEN SURFACES.
 *
 * This command, when not using -caret5-method, -edge-method, or -local-affine-method, is equivalent to using -surface-vertex-areas on each surface, smoothing both output metrics with the GEO_GAUSS_EQUAL method on the surface they came from if -smooth is specified, and then using the formula 'ln(distorted/reference)/ln(2)' on the smoothed results.
 *
 * When using -caret5-method, it uses the surface distortion method from caret5, which takes the base 2 log of the ratio of tile areas, then averages those results at each vertex, and then smooths the result on the reference surface.
 *
 * When using -edge-method, the -smooth option is ignored, and the output at each vertex is the average of 'abs(ln(refEdge/distortEdge)/ln(2))' over all edges connected to the vertex.
 *
 * When using -local-affine-method, the -smooth option is ignored.  The output is two columns, the first is the area distortion ratio, and the second is anisotropic strain.  These are calculated by an affine transform between matching triangles, and then averaged across the triangles of a vertex.
 *
 * @param metric_out the output distortion metric
 * @param surface_reference the reference surface
 * @param surface_distorted the distorted surface
 * @param smooth smooth the area data
 * @param match_surface_area isotropically rescale the distorted surface so that it has the same surface area as the reference surface
 * @param caret5_method use the surface distortion method from caret5
 * @param edge_method calculate distortion of edge lengths rather than areas
 * @param log2 calculate distortion by the local affines between triangles

apply base-2 log transform
 * @param runner Command runner
 *
 * @returns NamedTuple of outputs (described in `SurfaceDistortionOutputs`).
 */
function surface_distortion(
    metric_out: string,
    surface_reference: InputPathType,
    surface_distorted: InputPathType,
    smooth: SurfaceDistortionSmoothParameters | null = null,
    match_surface_area: SurfaceDistortionMatchSurfaceAreaParameters | null = null,
    caret5_method: boolean = false,
    edge_method: boolean = false,
    log2: boolean | null = false,
    runner: Runner | null = null,
): SurfaceDistortionOutputs {
    const params = surface_distortion_params(metric_out, surface_reference, surface_distorted, smooth, match_surface_area, caret5_method, edge_method, log2)
    return surface_distortion_execute(params, runner);
}


export {
      SURFACE_DISTORTION_METADATA,
      SurfaceDistortionOutputs,
      surface_distortion,
      surface_distortion_execute,
      surface_distortion_match_surface_area_params,
      surface_distortion_params,
      surface_distortion_smooth_params,
};
