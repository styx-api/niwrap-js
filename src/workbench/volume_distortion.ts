// This file was auto generated by Styx.
// Do not edit this file directly.

import { Runner, Execution, Metadata, InputPathType, OutputPathType, getGlobalRunner } from 'styxdefs';

const VOLUME_DISTORTION_METADATA: Metadata = {
    id: "71b5b8e30a3f86c052e4af8965fbf9041a247504.workbench",
    name: "volume-distortion",
    package: "workbench",
    container_image_tag: "nx10x/workbench:2.1.0",
};


interface VolumeDistortionParamsDict {
    "@type"?: "workbench/volume-distortion";
    "volume-out": string;
    "source-volume"?: string | null | undefined;
    "circular": boolean;
    "log2": boolean;
    "warpfield": string;
}
type VolumeDistortionParamsDictTagged = Required<Pick<VolumeDistortionParamsDict, '@type'>> & VolumeDistortionParamsDict;


/**
 * Output object returned when calling `VolumeDistortionParamsDict(...)`.
 *
 * @interface
 */
interface VolumeDistortionOutputs {
    /**
     * Output root folder. This is the root folder for all outputs.
     */
    root: OutputPathType;
    /**
     * the output distortion measures
     */
    volume_out: OutputPathType;
}


/**
 * Build parameters.
 *
 * @param volume_out the output distortion measures
 * @param warpfield the warpfield to compute the distortion of
 * @param source_volume MUST be used if using a fnirt warpfield

the source volume used when generating the warpfield
 * @param circular use the circle-based formula for the anisotropic measure
 * @param log2 apply base-2 log transform
 *
 * @returns Parameter dictionary
 */
function volume_distortion_params(
    volume_out: string,
    warpfield: string,
    source_volume: string | null = null,
    circular: boolean = false,
    log2: boolean = false,
): VolumeDistortionParamsDictTagged {
    const params = {
        "@type": "workbench/volume-distortion" as const,
        "volume-out": volume_out,
        "circular": circular,
        "log2": log2,
        "warpfield": warpfield,
    };
    if (source_volume !== null) {
        params["source-volume"] = source_volume;
    }
    return params;
}


/**
 * Build command-line arguments from parameters.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Command-line arguments.
 */
function volume_distortion_cargs(
    params: VolumeDistortionParamsDict,
    execution: Execution,
): string[] {
    const cargs: string[] = [];
    cargs.push(
        "wb_command",
        "-volume-distortion",
        (params["volume-out"] ?? null),
        "-fnirt",
        (params["source-volume"] ?? null),
        "-circular",
        "-log2"
    );
    cargs.push((params["warpfield"] ?? null));
    return cargs;
}


/**
 * Build outputs object containing output file paths and possibly stdout/stderr.
 *
 * @param params The parameters.
 * @param execution The execution object for resolving input paths.
 *
 * @returns Outputs object.
 */
function volume_distortion_outputs(
    params: VolumeDistortionParamsDict,
    execution: Execution,
): VolumeDistortionOutputs {
    const ret: VolumeDistortionOutputs = {
        root: execution.outputFile("."),
        volume_out: execution.outputFile([(params["volume-out"] ?? null)].join('')),
    };
    return ret;
}


/**
 * CALCULATE VOLUME WARPFIELD DISTORTION.
 *
 * Calculates isotropic and anisotropic distortions in the volume warpfield.  At each voxel, the gradient of the absolute warpfield is computed to obtain the local affine transforms for each voxel (jacobian matrices), and strain tensors are derived from them.  The isotropic component (volumetric expansion ratio) is the product of the three principal strains.  The default measure ('elongation') for the anisotropic component is the largest principal strain divided by the smallest.
 *
 * The -circular option instead calculates the anisotropic component by transforming the principal strains into log space, considering them as x-values of points on a circle 120 degrees apart, finds the circle's diameter, and transforms that back to a ratio.
 *
 * @param params The parameters.
 * @param runner Command runner
 *
 * @returns NamedTuple of outputs (described in `VolumeDistortionOutputs`).
 */
function volume_distortion_execute(
    params: VolumeDistortionParamsDict,
    runner: Runner | null = null,
): VolumeDistortionOutputs {
    runner = runner || getGlobalRunner();
    const execution = runner.startExecution(VOLUME_DISTORTION_METADATA);
    params = execution.params(params)
    const cargs = volume_distortion_cargs(params, execution)
    const ret = volume_distortion_outputs(params, execution)
    execution.run(cargs, undefined);
    return ret;
}


/**
 * CALCULATE VOLUME WARPFIELD DISTORTION.
 *
 * Calculates isotropic and anisotropic distortions in the volume warpfield.  At each voxel, the gradient of the absolute warpfield is computed to obtain the local affine transforms for each voxel (jacobian matrices), and strain tensors are derived from them.  The isotropic component (volumetric expansion ratio) is the product of the three principal strains.  The default measure ('elongation') for the anisotropic component is the largest principal strain divided by the smallest.
 *
 * The -circular option instead calculates the anisotropic component by transforming the principal strains into log space, considering them as x-values of points on a circle 120 degrees apart, finds the circle's diameter, and transforms that back to a ratio.
 *
 * @param volume_out the output distortion measures
 * @param warpfield the warpfield to compute the distortion of
 * @param source_volume MUST be used if using a fnirt warpfield

the source volume used when generating the warpfield
 * @param circular use the circle-based formula for the anisotropic measure
 * @param log2 apply base-2 log transform
 * @param runner Command runner
 *
 * @returns NamedTuple of outputs (described in `VolumeDistortionOutputs`).
 */
function volume_distortion(
    volume_out: string,
    warpfield: string,
    source_volume: string | null = null,
    circular: boolean = false,
    log2: boolean = false,
    runner: Runner | null = null,
): VolumeDistortionOutputs {
    const params = volume_distortion_params(volume_out, warpfield, source_volume, circular, log2)
    return volume_distortion_execute(params, runner);
}


export {
      VOLUME_DISTORTION_METADATA,
      VolumeDistortionOutputs,
      VolumeDistortionParamsDict,
      VolumeDistortionParamsDictTagged,
      volume_distortion,
      volume_distortion_execute,
      volume_distortion_params,
};
